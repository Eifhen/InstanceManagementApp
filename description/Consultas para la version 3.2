{"NombreConsulta":"Consultas para la version 3.2","Descripcion":"","Fecha":"2019-11-22","Consulta":"\r\nDROP procedure IF EXISTS `Cerrarbash`;\r\n\r\nDELIMITER $$\r\n\r\nCREATE  PROCEDURE `Cerrarbash`(id_bash int,fecha datetime,ingresos decimal(8,2),\r\ngastos decimal(8,2),impuestos decimal(8,2),cedula varchar(45), id_sucursal int,_fondos decimal(8,2)\r\n,_saldar decimal(8,2),_ingresos_impuesto decimal(8,2))\r\nBEGIN\r\n\r\n\/*Insertar el total de facturas por tipo de pagos *\/\r\ndeclare _tfacturacontado decimal (8,2);\r\ndeclare _tfacturacredito decimal (8,2);\r\ndeclare _tfacturachequeTra decimal (8,2);\r\n\r\nset _tfacturacontado=(select Get_TotalFactura(id_sucursal,'Al contado')as TotalContado);\r\nset _tfacturacredito=(select Get_TotalFactura(id_sucursal,'Cr\u00e9dito')as TotalContado);\r\nset _tfacturachequeTra=(select Get_TotalFactura(id_sucursal,'Cheque o transf')as TotalContado);\r\n\r\n\/*Insertando al bash los datos*\/\r\ninsert into bash values(date_format(fecha,'%Y%m%d'),\r\nfecha,ingresos,gastos,impuestos,cedula,id_sucursal,null,_fondos,_saldar,\r\n_ingresos_impuesto,_tfacturacontado,_tfacturacredito,_tfacturachequeTra);\r\n\r\nEND$$\r\n\r\nDELIMITER ;\r\n\r\nDROP TRIGGER IF EXISTS `TG_Facturas_contado`;\r\n\r\nDELIMITER $$\r\nCREATE  trigger TG_Facturas_contado after insert on facturas \r\n for each row\r\n begin \r\n declare Id_sucur int;\r\n set Id_sucur=(select usuarios.id_sucursal from facturas inner join usuarios on facturas.cedula_usuario=usuarios.cedula where facturas.Id_facturas= new.Id_facturas);\r\n if(New.Tipo_pago='Al contado')then\r\n\tINSERT INTO ingresos (Fecha,Cantidad,Tipo,idrefencia,idsucursal)value(new.fecha_registro,new.Total_Factura,'factura al contado',new.Id_facturas,Id_sucur);\r\n end if;\r\n  if(New.Tipo_pago='Cheque o transf')then\r\n\tINSERT INTO ingresos (Fecha,Cantidad,Tipo,idrefencia,idsucursal)value(new.fecha_registro,new.Total_Factura,'factura transferencia o cheque',new.Id_facturas,Id_sucur);\r\n end if;\r\n   if(New.Tipo_pago='Cr\u00e9dito')then\r\n\tINSERT INTO ingresos (Fecha,Cantidad,Tipo,idrefencia,idsucursal)value(new.fecha_registro,new.Total_Factura,'factura a Cr\u00e9dito',new.Id_facturas,Id_sucur);\r\n end if;\r\n end\r\nDELIMITER ;\r\n\r\nDROP TRIGGER IF EXISTS `TG_CuentasDiarias_Abonos`;\r\n\r\nDELIMITER $$\r\n\r\nCREATE  trigger TG_CuentasDiarias_Abonos after insert on abonos \r\n for each row\r\n begin \r\n declare Id_sucur int;\r\n set Id_sucur=(select usuarios.id_sucursal from abonos inner join usuarios on abonos.Usuario=usuarios.cedula where idAbonos= new.idAbonos);\r\n\tINSERT INTO ingresos (Fecha,Cantidad,Tipo,idrefencia,idsucursal)value(new.Fecha,new.Abonado,concat('Abono ',new.Tipo_abono),new.idAbonos,Id_sucur);\r\n end;$$\r\nDELIMITER ;\r\n\r\n\r\nDROP procedure IF EXISTS `ConfirmarPagos_pagados`;\r\n\r\nDELIMITER $$\r\n\r\nCREATE PROCEDURE `ConfirmarPagos_pagados`(idcuenta int, \r\ntipo_pagos varchar(15),cedula varchar(30),_tpago varchar(45),_nocuenta varchar(45))\r\nBEGIN\r\ndeclare fecha,cierre datetime;\r\ndeclare periodos varchar(15);\r\n\r\nset fecha=(select Fecha_registro from cuentaspagar where idcuentaspagar=idcuenta);\r\nset cierre=(select Fecha_cierre from cuentaspagar where idcuentaspagar=idcuenta);\r\nset periodos=(select Periodo from cuentaspagar where idcuentaspagar=idcuenta);\r\n\r\ninsert into pagos(Usuario, Tipo_pago, Id_cuenta,tpago,noCuenta) \r\nvalue(cedula,tipo_pagos,concat('cp',idcuenta),_tpago,_nocuenta);\r\n\r\nif(tipo_pagos='Pago recurrente')then\r\nif (periodos='Semanal')then\r\nupdate cuentaspagar set Fecha_registro= date_add(fecha,INTERVAL 7 DAY),Fecha_cierre=date_add(cierre,INTERVAL 7 DAY)  where idcuentaspagar=idcuenta;\r\nend if;\r\nif( periodos='Mensual') then\r\nupdate cuentaspagar set Fecha_registro= date_add(fecha,INTERVAL 1 Month),Fecha_cierre=date_add(cierre,INTERVAL 1 month)  where idcuentaspagar=idcuenta;\r\nend if;\r\n if(periodos='Quincenal')then\r\nupdate cuentaspagar set Fecha_registro= date_add(fecha,INTERVAL 15 Day),Fecha_cierre=date_add(cierre,INTERVAL 15 DAY)  where idcuentaspagar=idcuenta;\r\nend if;\r\nif(periodos='Anual')then\r\nupdate cuentaspagar set Fecha_registro= date_add(fecha,INTERVAL 1 year),Fecha_cierre=date_add(cierre,INTERVAL 1 year) where idcuentaspagar=idcuenta;\r\nend if;\r\nelse \r\nupdate cuentaspagar set Estado_cuenta='Inactiva' where idcuentaspagar=idcuenta;\r\nend if;\r\nEND;$$\r\n\r\nDELIMITER ;\r\n\r\n\r\nDROP procedure IF EXISTS `ConfirmarPagos`;\r\n\r\nDELIMITER $$\r\n\r\nCREATE  PROCEDURE `ConfirmarPagos`(idcuenta int, tipo_pagos \r\nvarchar(15),cedula varchar(30),fecha_p datetime,_tpago varchar(45),_nocuenta varchar(45))\r\nBEGIN\r\ndeclare fecha,cierre datetime;\r\ndeclare periodos varchar(15);\r\n\r\nset fecha=(select Fecha_registro from cuentascobros where Id_cobros=idcuenta);\r\nset cierre=(select Fecha_cierre from cuentascobros where Id_cobros=idcuenta);\r\nset periodos=(select Periodo from cuentascobros where Id_cobros=idcuenta);\r\n\r\ninsert into pagos(Usuario, Tipo_pago, Id_cuenta,Fecha_pago,tpago,noCuenta) \r\nvalue(cedula,tipo_pagos,concat('cc',idcuenta),fecha_p,_tpago,_nocuenta);\r\n\r\nif(tipo_pagos='Pago recurrente')then\r\nif (periodos='Semanal')then\r\nupdate cuentascobros set Fecha_registro= date_add(fecha,INTERVAL 7 DAY),Fecha_cierre=date_add(cierre,INTERVAL 7 DAY)  where Id_cobros=idcuenta;\r\nend if;\r\nif( periodos='Mensual') then\r\nupdate cuentascobros set Fecha_registro= date_add(fecha,INTERVAL 1 Month),Fecha_cierre=date_add(cierre,INTERVAL 1 month)  where Id_cobros=idcuenta;\r\nend if;\r\n if(periodos='Quincenal')then\r\nupdate cuentascobros set Fecha_registro= date_add(fecha,INTERVAL 15 Day),Fecha_cierre=date_add(cierre,INTERVAL 15 DAY)  where Id_cobros=idcuenta;\r\nend if;\r\nif(periodos='Anual')then\r\nupdate cuentascobros set Fecha_registro= date_add(fecha,INTERVAL 1 year),Fecha_cierre=date_add(cierre,INTERVAL 1 year) where Id_cobros=idcuenta;\r\nend if;\r\nelse \r\nupdate cuentascobros set Estado_cuenta='Inactiva' where Id_cobros=idcuenta;\r\nend if;\r\nEND$$\r\n\r\nDELIMITER ;\r\n\r\nDROP TRIGGER IF EXISTS `TG_CuentasDiarias_Pagos`;\r\n\r\nDELIMITER $$\r\n\r\nCREATE  trigger TG_CuentasDiarias_Pagos after insert on pagos \r\n for each row\r\n begin \r\n declare tipo varchar(45);\r\n declare _tipo varchar(45);\r\n declare _proveedor varchar(25);\r\n declare _cuenta varchar(45);\r\n declare _conceto text;\r\n declare cantidad decimal(8,2);\r\n declare Id_sucur int;\r\n set Id_sucur=(select usuarios.id_sucursal from pagos inner join usuarios on pagos.Usuario=usuarios.cedula where idPagos= new.idPagos);\r\n\r\nif(substring(new.Id_cuenta,1,2)='cc')then\r\nset cantidad=(select Total_cuenta from cuentascobros where concat('cc',Id_cobros)=new.Id_cuenta);\r\nset tipo=concat('Cuentas por cobrar ',new.tpago);\r\n\r\n INSERT INTO ingresos (Fecha,Cantidad,Tipo,idrefencia,idsucursal)\r\n value(new.Fecha_pago,cantidad,tipo,new.Id_cuenta,Id_sucur);\r\n\r\n\/*Verificando si fue a transferencia bancaria para afectar la tabla transferencia y confirmar el Credito*\/\r\nif(new.tpago='Transferencia Bancaria')then\r\ninsert into transferencia values(null,new.noCuenta,now(),'Confirmada','Credito',cantidad,\r\nconcat('Transferencia de ',tipo),new.Id_cuenta,0);\r\n\r\nupdate banking set balance=balance+cantidad where ncuenta=new.noCuenta;\r\nend if;\r\nelse\r\nset cantidad=(select Total_cuenta from cuentaspagar where concat('cp',idcuentaspagar)=new.Id_cuenta);\r\nset _conceto=(select Concepto from cuentaspagar where concat('cp',idcuentaspagar)=new.Id_cuenta);\r\nset _proveedor=(select Nombre_proveedor from proveedores join cuentaspagar on proveedores.idProveedores=cuentaspagar.Id_proveedor where concat('cp',idcuentaspagar)=new.Id_cuenta);\r\nset _tipo=concat('Cuentas por pagar ',new.tpago);\r\n\r\n\/*Verificando si fue a transferencia bancaria para afectar la tabla transferencia y confirmar el debito*\/\r\nif(new.tpago='Transferencia Bancaria')then\r\ninsert into transferencia values(null,new.noCuenta,now(),'Confirmada','Debito',cantidad,\r\nconcat('Transferencia de ',_tipo),new.Id_cuenta,0);\r\n\r\nupdate banking set balance=balance-cantidad where ncuenta=new.noCuenta;\r\nend if;\r\ninsert into gastos_menores(descripcion,suplidor,tipo,hora,monto,estado,idsucursal,idbash) \r\nvalues(_conceto,_proveedor,_tipo,hour(now()),cantidad,'activo',Id_sucur,DATE_FORMAT(now(),\"%Y%m%d\"));\r\nend if;\r\n end;$$\r\nDELIMITER ;\r\n\r\n"}